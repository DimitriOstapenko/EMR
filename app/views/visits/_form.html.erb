<%= form_for [@patient, @visit]  do |f| %> 
  <%= render 'shared/error_messages', object: f.object %>
  
  <% doc_id = @visit.doctor.id || current_doctor.id %>
  <% @procedures = get_active_procedures %>

<div class="row">
  <div class="col-md-3 col-md-offset-1">

  <%= f.label "Doctor" %>
  <%= f.collection_select(:doc_id, get_active_doctors, :id, :lname, prompt: 'Select', selected: doc_id) %>  

  <%= f.label "Diagnosis" %>
  <%=  f.collection_select(:diag_code, get_active_diagnoses, :code, :code, prompt: 'Select')  %> 

  <div class="col-md-4 padding-0">
  <%= f.label "Duration" %>
  <%= f.select :duration, DURATIONS, default: 10  %>
  </div>

  <div class="col-md-8 ">
  <%= f.label "Visit Type" %>
  <%= f.select :vis_type, VISIT_TYPES, placeholder: 'Visit type', default: 'WS' %>
  </div>

  <%= f.label "Status" %>
  <%= f.select :status, VISIT_STATUSES, placeholder: 'Status' %>
    
  </div>

  <div class="col-md-8"> </div>
  <div class="col-md-1">
  <%= f.label "Procedure" %>
  <%= f.collection_select :proc_code, @procedures, :code, :code, prompt: 'Select'  %>
  <%= f.hidden_field(:fee, id: :fee) %>  
  </div>

  <div class="col-md-1">
  <%= f.label "Procedure" %>
  <%= f.collection_select(:proc_code2, @procedures, :code, :code, prompt: 'Select')  %>
  </div>
  
  <div class="col-md-1">
  <%= f.label "Procedure" %>
  <%= f.collection_select(:proc_code3, @procedures, :code, :code, prompt: 'Select')  %>
  </div>
  
  <div class="col-md-1">
  <%= f.label "Procedure" %>
  <%= f.collection_select(:proc_code4, @procedures, :code, :code, prompt: 'Select')  %>
  </div>

  <div class="col-md-8"> </div>
  <div class="col-md-1">
  <%= f.label :units %>
  <%= f.select :units, UNITS, prompt:  'Select' %>
  </div>

  <div class="col-md-1">
  <%= f.label :units %>
  <%= f.select :units2, UNITS, prompt: 'Select' %>
  </div>

  <div class="col-md-1">
  <%= f.label :units %>
  <%= f.select :units3, UNITS, prompt: 'Select' %>
  </div>

  <div class="col-md-1">
  <%= f.label :units %>
  <%= f.select :units4, UNITS, prompt: 'Select' %>
  </div>

  <div class="col-md-8"> </div>
  <div class="col-md-1">
  <%= f.label "Bill Type" %>
  <%= f.select :bil_type, BILLING_TYPES, prompt: 'Select' %>
  </div>

  <div class="col-md-1">
  <%= f.label "Bill Type" %>
  <%= f.select :bil_type2, BILLING_TYPES, prompt: 'Select' %>
  </div>

  <div class="col-md-1">
  <%= f.label "Bill Type" %>
  <%= f.select :bil_type3, BILLING_TYPES,  prompt: 'Select' %>
  </div>

  <div class="col-md-1">
  <%= f.label "Bill Type" %>
  <%= f.select :bil_type4, BILLING_TYPES, prompt: 'Select'%>
  </div>

  <div class="col-md-8"> </div>
  <div class="col-md-4">
  <%= f.label "Reason for Visit" %>
  <%= f.text_field :reason %>
  </div>

  <div class="col-md-12"> </div>
  <div class="col-md-7 col-md-offset-1">

  <%= f.text_area :notes, rows:10, placeholder: 'Notes' %>
  <%= f.submit yield(:button_text), class: "btn btn-primary" %>
  </div>
</div>

<% end %>

<script>

$('#new_visit select[name="visit[proc_code]"]').change(function () {
  get_bil_type( $(this).val() , '');
});
$('#new_visit select[name="visit[proc_code2]"]').change(function () {
  get_bil_type( $(this).val() , '2' );
});
$('#new_visit select[name="visit[proc_code3]"]').change(function () {
  get_bil_type( $(this).val() , '3' );
});
$('#new_visit select[name="visit[proc_code4]"]').change(function () {
  get_bil_type( $(this).val() , '4' );
});

function get_bil_type ( code, suff ) {
	var request = "/procedures/get_by_code?code=" + code;
	var aj = $.ajax({
        url: request,
        type: 'get',
        data: $(this).serialize()
    }).done(function (data) {
        select_btype(data, suff);
    }).fail(function (data) {
         console.log('AJAX request has FAILED');
    });
}

function select_btype( proc, suff ) {
 var fname = 'visit_bil_type'+suff
 var v = document.getElementById(fname);
 for (var i = 0; i < v.options.length; i++) {
    if (v.options[i].text === proc.ptype) {
        v.selectedIndex = i;
        break;
    }
 }
}
</script>
